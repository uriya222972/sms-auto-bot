{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">מערכת הטלפנים</h2>

  <form method="post" enctype="multipart/form-data">
    <label for="file">בחר קובץ:</label>
    <input type="file" name="file" id="file" onchange="document.getElementById('filename').textContent = this.files[0]?.name || 'לא נבחר קובץ'">
    <span id="filename">{{ filename or "לא נבחר קובץ" }}</span>
    <button class="btn btn-primary btn-sm" formaction="/upload" formmethod="post">העלה</button>
  </form>

  <form method="post">
    <label for="activation_word">מילת הפעלה:</label>
    <input type="text" id="activation_word" name="activation_word" value="{{ activation_word }}" required>
    <button class="btn btn-secondary btn-sm" type="submit" name="update_activation_word">שמור</button>

    <label for="template" class="mt-3">תבנית הודעה:</label>
    <input type="text" id="template" name="template" value="{{ template }}" style="width: 100%;" required>
    <small class="form-text text-muted">השתמש ב־<code>{next}</code> במקום שבו ייכנס המספר הבא מהרשימה</small>
    <button class="btn btn-secondary btn-sm mt-1" type="submit" name="update_template">שמור</button>
  </form>

  <form method="post">
    <h4 class="mt-4">הגדרות תגובות:</h4>
    <table class="table">
      <thead>
        <tr><th>ספרה</th><th>פירוש</th><th>שיחה חוזרת?</th><th>שעות</th></tr>
      </thead>
      <tbody>
        {% for key, setting in response_map.items() %}
        <tr>
          <td>{{ key }}</td>
          <td><input type="text" name="label_{{ key }}" value="{{ setting.label }}"></td>
          <td><input type="checkbox" name="callback_{{ key }}" {% if setting.callback_required %}checked{% endif %}></td>
          <td><input type="number" name="hours_{{ key }}" value="{{ setting.hours }}"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button class="btn btn-primary" type="submit" name="update_response_map">שמור הגדרות</button>
  </form>

  <hr>

  <h4>מספרים ברשימה:</h4>
  <table class="table table-bordered table-sm">
    <thead>
      <tr>
        <th>#</th>
        <th>מספר</th>
        <th>נשלח?</th>
        <th>תגובת טלפן</th>
        <th>פירוש</th>
        <th>שעה</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ row }}</td>
        <td>{% if loop.index0 in send_log %}✔️{% endif %}</td>
        <td>{{ responses.get(loop.index0, {}).get('message', '') }}</td>
        <td>{{ responses.get(loop.index0, {}).get('label', '') }}</td>
        <td>{{ responses.get(loop.index0, {}).get('time', '') }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
