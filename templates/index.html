<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ניהול הודעות SMS</title>
    <style>
        body {
            font-family: sans-serif;
            direction: rtl;
            max-width: 1200px;
            margin: auto;
            padding: 2em;
            background: #f9f9f9;
        }
        h1 { text-align: center; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            background: white;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 0.6em;
            text-align: center;
        }
        th {
            background: #e0e0e0;
        }
        form {
            margin-top: 2em;
            padding: 1em;
            background: white;
            border: 1px solid #ccc;
        }
        label {
            display: inline-block;
            width: 8em;
            margin-left: 1em;
        }
        input[type="text"], input[type="number"] {
            width: 20em;
        }
    </style>
</head>
<body>
    <h1>מערכת שליחת SMS</h1>

    <p>סה"כ הודעות שנשלחו: <strong>{{ total_sent }}</strong></p>

    <form action="/upload" method="post" enctype="multipart/form-data">
        <input type="file" name="file" required onchange="this.form.submit()">
    </form>

    <form method="post" action="/reset" onsubmit="return confirm('לאפס את כל הנתונים?')">
        <button type="submit">איפוס נתונים</button>
    </form>

    <form method="post">
        <h2>תבנית הודעה</h2>
        <label>תבנית:</label>
        <input type="text" name="template" value="{{ template }}" style="width: 80%;">
        <button type="submit" name="update_template">עדכן</button>
    </form>

    <form method="post">
        <h2>הגדרות תגובה לפי ספרה</h2>
        {% for digit, config in response_map.items() %}
            <div style="margin-bottom: 0.5em;">
                <label>ספרה {{ digit }}:</label>
                <input type="text" name="label_{{ digit }}" value="{{ config.label }}">
                <label>חזרה?</label>
                <input type="checkbox" name="callback_{{ digit }}" {% if config.callback_required %}checked{% endif %}>
                <label>בעוד (שעות):</label>
                <input type="number" name="hours_{{ digit }}" value="{{ config.hours }}" min="0">
            </div>
        {% endfor %}
        <button type="submit" name="update_response_map">שמור הגדרות</button>
    </form>

    <h2>רשימת שיחות</h2>
    <table>
        <thead>
            <tr>
                <th>מס'</th>
                <th>הודעה שנשלחה</th>
                <th>למספר</th>
                <th>זמן שליחה</th>
                <th>תגובה</th>
                <th>פירוש</th>
                <th>זמן תגובה</th>
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ send_log.get(loop.index0, {}).get("message", row) }}</td>
                <td>{{ send_log.get(loop.index0, {}).get("to", "") }}</td>
                <td>{{ send_log.get(loop.index0, {}).get("time", "") }}</td>
                <td>{{ responses.get(loop.index0, {}).get("message", "") }}</td>
                <td>{{ responses.get(loop.index0, {}).get("label", "") }}</td>
                <td>{{ responses.get(loop.index0, {}).get("time", "") }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p><a href="/download">📥 הורד טבלת תגובות כ־CSV</a></p>
</body>
</html>
