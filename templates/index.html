{% extends "base.html" %}
{% block content %}
<h1 class="text-center mb-4">מערכת SMS טלפונית</h1>

<div class="row">
    <div class="col-md-6">
        <form method="post" enctype="multipart/form-data">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">העלאת קובץ מספרים</h5>
                    <input type="file" name="file" id="file" class="form-control mb-2" required onchange="updateFilename()">
                    <p id="filename-display">{{ filename or 'לא נבחר קובץ' }}</p>
                    <button type="submit" class="btn btn-primary">העלה</button>
                </div>
            </div>
        </form>
    </div>

    <div class="col-md-6">
        <form method="post">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">הגדרת מילת הפעלה</h5>
                    <input type="hidden" name="update_activation_word">
                    <input type="text" name="activation_word" value="{{ activation_word }}" class="form-control mb-2" required>
                    <button type="submit" class="btn btn-success">שמור</button>
                </div>
            </div>
        </form>
    </div>
</div>

<form method="post">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">התאמה אישית של הודעה</h5>
            <input type="hidden" name="update_template">
            <textarea name="template" class="form-control" rows="2" required>{{ template }}</textarea>
            <button type="submit" class="btn btn-secondary mt-2">שמור</button>
        </div>
    </div>
</form>

<h2 class="mt-4">סטטיסטיקות</h2>
<div class="row" id="stats-container">
    {% for key, count in stats.items() %}
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="stat-label">{{ key }}</div>
                <h4>{{ count }}</h4>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<h2 class="mt-4">רשימת שיחות</h2>
<table class="table table-striped table-hover sortable">
    <thead>
        <tr>
            <th>מספר</th>
            <th>זמן שליחה</th>
            <th>תגובה</th>
            <th>זמן תגובה</th>
            <th>חזרה מתוזמנת</th>
        </tr>
    </thead>
    <tbody id="data-table">
        {% for i, row in enumerate(rows) %}
        <tr>
            <td>{{ row }}</td>
            <td>{{ send_log[i].time if send_log[i] is defined else '' }}</td>
            <td>{{ responses[i].label if responses[i] is defined else '' }}</td>
            <td>{{ responses[i].time if responses[i] is defined else '' }}</td>
            <td id="retry-{{ i }}"></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function updateFilename() {
    const input = document.getElementById("file");
    const display = document.getElementById("filename-display");
    if (input.files.length > 0) {
        display.innerText = input.files[0].name;
    }
}

async function refreshData() {
    const res = await fetch('/data');
    const data = await res.json();
    for (const i in data.retry_times) {
        const el = document.getElementById('retry-' + i);
        if (el) el.innerText = data.retry_times[i];
    }

    // ניתן להרחיב כאן לרענון סטטיסטיקות וגרפים דינמיים
}

setInterval(refreshData, 10000);
refreshData();
</script>
{% endblock %}
