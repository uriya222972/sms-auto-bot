<div style="font-size: 14px; color: #555; text-align: left; margin-bottom: 10px;">
  משתמש מחובר: <strong>{{ username }}</strong>
</div>

<div class="header-bar">
  <div class="logo-title">📱 מערכת SMS אוטומטית</div>
  <a href="/telephony" target="_blank" class="telephony-button">פתח ממשק טלפנים</a>
</div>

<div class="section">
  <form action="/reset" method="post" onsubmit="return confirm('האם אתה בטוח שברצונך לאפס את המערכת?');">
    <input type="submit" value="אפס מערכת">
  </form>
  <h2>העלאת קובץ CSV</h2>
  <form action="/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept=".csv" required>
    <input type="submit" value="העלה קובץ">
  </form>
  {% if filename %}<p><strong>קובץ נבחר:</strong> {{ filename }}</p>{% endif %}
</div>

<div class="section">
  <h2>הגדרות תגובה לספרות</h2>
  <form method="post">
    <input type="hidden" name="update_response_map">
    <div class="response-grid">
      {% for digit, config in response_map.items() %}
        <div>
          <label>{{ digit }}:</label>
          <input type="text" name="label_{{ digit }}" value="{{ config.label }}" placeholder="לדוג' תרם">
          <label>חזרה:</label>
          <input type="checkbox" name="callback_{{ digit }}" {% if config.callback_required %}checked{% endif %}>
          <label>שעות:</label>
          <input type="number" name="hours_{{ digit }}" value="{{ config.hours }}" min="0" style="width: 50px;">
          <label>הודעות עידוד:</label>
          <textarea name="encouragements_{{ digit }}">{{ config.encouragements | join('\n') }}</textarea>
        </div>
      {% endfor %}
    </div>
    <input type="submit" value="שמור שינויים">
  </form>
</div>

<div class="section">
  <h2>ציר יעד</h2>
  <form method="post">
    <input type="hidden" name="update_target_goals">
    <label>יעד:</label>
    <input type="number" name="target_goal" value="{{ target_goal }}">
    <label>יעד בונוס:</label>
    <input type="number" name="bonus_goal" value="{{ bonus_goal }}">
    <label>הפעל בונוס:</label>
    <input type="checkbox" name="bonus_active" {% if bonus_active %}checked{% endif %}>
    <input type="submit" value="שמור">
  </form>
  <div class="progress-bar">
    <div class="progress-bar-inner" style="width: {{ total_sent / target_goal * 100 if target_goal else 0 }}%">
      {{ total_sent }} / {{ target_goal }} <span class="arrow">⬆</span>
    </div>
  </div>
  {% if bonus_active %}
    <div class="progress-bar" style="margin-top: 10px; background: #ffe0b2;">
      <div class="progress-bar-inner" style="background: #fb8c00; width: {{ total_sent / bonus_goal * 100 if bonus_goal else 0 }}%">
        {{ total_sent }} / {{ bonus_goal }} (בונוס) <span class="arrow">⬆</span>
      </div>
    </div>
  {% endif %}
</div>

<div class="section">
  <form action="/download">
    <input type="submit" value="הורד נתונים כ־CSV">
  </form>
</div>

<div class="section">
  <h2>טבלת נתונים</h2>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>יעד</th>
        <th>הודעה שנשלחה</th>
        <th>נשלח אל</th>
        <th>זמן שליחה</th>
        <th>פירוש תגובה</th>
        <th>זמן תגובה</th>
      </tr>
    </thead>
    <tbody>
      {% for i in range(rows|length) %}
        <tr>
          <td>{{ i + 1 }}</td>
          <td>{{ name_map.get(rows[i], rows[i]) }}</td>
          <td>{{ send_log[i].message if send_log[i] is defined }}</td>
          <td>{{ send_log[i].to if send_log[i] is defined }}</td>
          <td>{{ send_log[i].time if send_log[i] is defined }}</td>
          <td>{{ responses[i].label if responses[i] is defined }}</td>
          <td>{{ responses[i].time if responses[i] is defined }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
